{"id":"SC9zUkWz5rSIjWjr","meta":{"instanceId":"6c1eaebd3134b9928125703ba12d6e566eb967296190fb971177c1225836987d"},"name":"AI-Enhanced SMS Conversational Flow","tags":[],"nodes":[{"id":"8fb0954c-b2b4-429f-ba86-40187e774a1d","name":"Incoming SMS Webhook","type":"n8n-nodes-base.webhook","position":[-784,432],"webhookId":"twilio_sms_incoming","parameters":{"path":"twilio_sms_incoming","options":{},"httpMethod":"POST","responseMode":"responseNode"},"typeVersion":1},{"id":"7af3fa1e-3757-4ea2-8237-21ae1d0f6970","name":"Extract SMS Data","type":"n8n-nodes-base.code","position":[-576,432],"parameters":{"jsCode":"const fromNumber = $input.item.json.From;\nconst messageBody = $input.item.json.Body || '';\nconst messageSid = $input.item.json.MessageSid;\n\nreturn {\n  from_number: fromNumber,\n  message_body: messageBody,\n  message_sid: messageSid,\n  received_at: new Date().toISOString()\n};"},"typeVersion":2},{"id":"31e5b76e-82b2-4e20-8ab9-e5918ee48cac","name":"Find User Session","type":"n8n-nodes-base.postgres","position":[-384,432],"parameters":{"sort":{"values":[{"column":"created_at","direction":"DESC"}]},"limit":1,"table":"user_sessions","where":{"values":[{"value":"={{ $json.from_number }}","column":"phone_number"}]},"schema":"public","options":{},"operation":"select"},"typeVersion":2},{"id":"09896974-0493-4363-98f5-13f2d391486e","name":"AI Sentiment & Intent Analysis","type":"n8n-nodes-base.httpRequest","notes":"Placeholder: Swap to AI node after import","position":[-176,432],"parameters":{"url":"https://api.groq.com/openai/v1/chat/completions","method":"POST","options":{},"sendBody":true,"sendHeaders":true,"authentication":"predefinedCredentialType","bodyParameters":{"parameters":[{"name":"model","value":"llama-3.1-70b-versatile"},{"name":"messages","value":"=[{\"role\": \"system\", \"content\": \"You are an AI assistant analyzing SMS messages for sentiment, intent, and urgency. Respond with ONLY a valid JSON object containing: sentiment (positive/negative/neutral/frustrated), urgency_score (1-10), intent (continue_intake/complete_session/help_request), requires_escalation (true/false), detected_keywords (array), and summary (brief description).\"}, {\"role\": \"user\", \"content\": \"Analyze this SMS message: {{ $('Extract SMS Data').item.json.message_body }}\"}]"},{"name":"temperature","value":"0.3"},{"name":"max_tokens","value":"300"}]},"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"nodeCredentialType":"groqApi"},"typeVersion":4.2},{"id":"a54d073a-de1c-44b7-894c-447b7a3e9f18","name":"Process & Store AI Analysis","type":"n8n-nodes-base.code","notes":"Processes AI output and stores it with transcript in structured format","position":[16,432],"parameters":{"jsCode":"// Parse Groq API response and sanitize\nlet aiAnalysis;\ntry {\n  // Groq API returns response in choices[0].message.content\n  const groqResponse = $input.item.json;\n  const rawResponse = groqResponse.choices?.[0]?.message?.content || '{}';\n  \n  // Remove markdown code blocks if present\n  const cleanedResponse = rawResponse.replace(/```json\\n?|```\\n?/g, '').trim();\n  aiAnalysis = JSON.parse(cleanedResponse);\n} catch (e) {\n  // Fallback if AI response is invalid\n  aiAnalysis = {\n    sentiment: 'neutral',\n    urgency_score: 5,\n    intent: 'continue_intake',\n    requires_escalation: false,\n    detected_keywords: [],\n    summary: $('Extract SMS Data').item.json.message_body\n  };\n}\n\n// Get session data\nconst sessionData = $('Find User Session').item.json;\nlet intakeData;\ntry {\n  intakeData = JSON.parse(sessionData.intake_data || '{}');\n} catch (e) {\n  intakeData = { transcript: [], ai_metadata: {} };\n}\n\n// Initialize structures\nif (!intakeData.transcript) intakeData.transcript = [];\nif (!intakeData.ai_metadata) intakeData.ai_metadata = {};\n\n// Add message with AI analysis to transcript\nintakeData.transcript.push({\n  message: $('Extract SMS Data').item.json.message_body,\n  timestamp: $('Extract SMS Data').item.json.received_at,\n  direction: 'incoming',\n  ai_analysis: aiAnalysis\n});\n\n// Update aggregate AI metadata\nintakeData.ai_metadata.last_sentiment = aiAnalysis.sentiment;\nintakeData.ai_metadata.last_intent = aiAnalysis.intent;\nintakeData.ai_metadata.max_urgency = Math.max(\n  intakeData.ai_metadata.max_urgency || 0,\n  aiAnalysis.urgency_score\n);\nintakeData.ai_metadata.escalation_count = (intakeData.ai_metadata.escalation_count || 0) + \n  (aiAnalysis.requires_escalation ? 1 : 0);\n\nreturn {\n  session_id: sessionData.session_id,\n  phone_number: sessionData.phone_number,\n  status: sessionData.status,\n  intake_data: JSON.stringify(intakeData),\n  ai_analysis: aiAnalysis,\n  original_message: $('Extract SMS Data').item.json.message_body\n};"},"typeVersion":2},{"id":"6464f142-283d-4a0c-a603-574e43d6f828","name":"AI Escalation Router","type":"n8n-nodes-base.switch","notes":"AI NODE 2: Routes to escalation based on AI-detected frustration/urgency","position":[208,432],"parameters":{"rules":{"rules":[{}]}},"typeVersion":2},{"id":"ced4f895-4c1c-40c4-b089-4f7b6b9882b4","name":"Mark Session as Escalated","type":"n8n-nodes-base.postgres","position":[688,544],"parameters":{"table":"user_sessions","schema":"public","options":{},"operation":"update"},"typeVersion":2},{"id":"f5e0cafc-99e3-40ae-bc4f-062e1c131ec5","name":"Prepare Escalation Data","type":"n8n-nodes-base.code","position":[432,432],"parameters":{"jsCode":"// Prepare escalation context with AI insights\nconst aiAnalysis = $json.ai_analysis;\nconst sessionData = $json;\n\nreturn {\n  session_id: sessionData.session_id,\n  phone_number: sessionData.phone_number,\n  status: 'escalated',\n  escalated_at: new Date().toISOString(),\n  escalation_reason: JSON.stringify({\n    sentiment: aiAnalysis.sentiment,\n    urgency_score: aiAnalysis.urgency_score,\n    intent: aiAnalysis.intent,\n    detected_keywords: aiAnalysis.detected_keywords,\n    summary: aiAnalysis.summary\n  })\n};"},"typeVersion":2},{"id":"bf1ba7c2-03a6-4610-b33b-1b48cdb89bfc","name":"Send AI Escalation Email","type":"n8n-nodes-base.gmail","position":[688,352],"webhookId":"4903ab6f-10b8-45a7-95f0-60e7d9742181","parameters":{"sendTo":"support@company.com","message":"=**AI-Detected Escalation Alert**\n\n**Phone:** {{ $json.phone_number }}\n**Session ID:** {{ $json.session_id }}\n\n**AI Analysis:**\n- Sentiment: {{ $json.ai_analysis.sentiment }}\n- Urgency Score: {{ $json.ai_analysis.urgency_score }}/10\n- Intent: {{ $json.ai_analysis.intent }}\n\n**Last Message:** {{ $json.original_message }}\n\n**AI Summary:** {{ $json.ai_analysis.summary }}\n\n**Detected Keywords:** {{ $json.ai_analysis.detected_keywords.join(', ') }}\n\n**Time:** {{ $json.received_at }}\n\nPlease review and respond promptly.","options":{},"subject":"ðŸš¨ AI-Detected Escalation Required - {{ $json.ai_analysis.sentiment }}"},"typeVersion":2},{"id":"11121743-82b6-42ad-9078-fa940ae8bfd6","name":"Send Escalation SMS","type":"n8n-nodes-base.httpRequest","notes":"Placeholder: Swap to AI node after import","position":[880,352],"parameters":{"url":"=https://api.twilio.com/2010-04-01/Accounts/{{$env.TWILIO_ACCOUNT_SID}}/Messages.json","options":{},"authentication":"basicAuth"},"typeVersion":2},{"id":"ed7fc73c-b267-4f91-8fa1-4545b0e6a7e9","name":"Sticky Note","type":"n8n-nodes-base.stickyNote","position":[-576,-496],"parameters":{"color":5,"width":1088,"height":256,"content":"## User Signup\n"},"typeVersion":1},{"id":"b7657782-593c-4052-8915-4411d3b5c657","name":"Sticky Note1","type":"n8n-nodes-base.stickyNote","position":[-768,-208],"parameters":{"color":3,"width":1584,"height":464,"content":"## Verification Agent"},"typeVersion":1},{"id":"6c4f0a1f-7c3c-4c74-acdd-711126a8b44f","name":"Sticky Note2","type":"n8n-nodes-base.stickyNote","position":[-832,320],"parameters":{"color":4,"width":1904,"height":416,"content":"## Escalation Agent"},"typeVersion":1},{"id":"3d20321f-b131-48b7-9dae-4cde4e746cb2","name":"Sticky Note3","type":"n8n-nodes-base.stickyNote","position":[-832,784],"parameters":{"color":6,"width":2048,"height":896,"content":"## Response Agent"},"typeVersion":1},{"id":"1e917a1b-226e-4781-a658-b386e171581b","name":"Store Verification","type":"n8n-nodes-base.postgres","position":[-80,-400],"parameters":{"table":"user_verifications","schema":"public","options":{}},"typeVersion":2},{"id":"af1b2159-4d70-410b-9c32-633c3244ee82","name":"Send Verification SMS (Twilio API)","type":"n8n-nodes-base.httpRequest","position":[128,-400],"parameters":{"url":"https://api.twilio.com/2010-04-01/Accounts/{{ $credentials.accountSid }}/Messages.json","options":{},"sendBody":true,"authentication":"genericCredentialType","bodyParameters":{"parameters":[{"name":"To","value":"={{ $json.phone_number }}"},{"name":"From","value":"+1234567890"},{"name":"Body","value":"Your verification code is: {{ $json.verification_code }}. Expires in 10 minutes."}]},"genericAuthType":"httpBasicAuth"},"typeVersion":4},{"id":"6352fdab-c3e1-467b-aa0c-ff3ebbc7204c","name":"Check Verification","type":"n8n-nodes-base.postgres","position":[-288,-16],"parameters":{"sort":{"values":[{"column":"created_at","direction":"DESC"}]},"limit":1,"table":"user_verifications","where":{"values":[{"value":"={{ $json.phone_number }}","column":"phone_number"},{"value":"false","column":"verified"}]},"schema":"public","options":{},"operation":"select"},"typeVersion":2},{"id":"60594a25-df6b-43e0-9749-81ae28e6ae01","name":"Validate Code","type":"n8n-nodes-base.switch","position":[-80,-16],"parameters":{"rules":{"values":[{"conditions":{"options":{"version":1,"leftValue":"","caseSensitive":true,"typeValidation":"strict"},"combinator":"and","conditions":[{"id":"9df14424-8f64-426b-878d-f696ccba98cc","operator":{"type":"string","operation":"equals"},"leftValue":"","rightValue":""}]}}]},"options":{}},"typeVersion":3},{"id":"97e91597-6b1f-4eb1-afff-fd0e564e1785","name":"Create Session","type":"n8n-nodes-base.code","position":[112,-128],"parameters":{"jsCode":"const sessionId = 'sess_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);\nreturn {\n  phone_number: $('Extract Verification Data1').item.json.phone_number,\n  session_id: sessionId,\n  verified_at: new Date().toISOString(),\n  intake_data: JSON.stringify({transcript: [], ai_metadata: {}, structured_data: {}}),\n  status: 'active',\n  created_at: new Date().toISOString()\n};"},"typeVersion":2},{"id":"d95fb2f3-99dd-49b5-b8fa-f21370fcc7f8","name":"Mark Verified","type":"n8n-nodes-base.postgres","position":[320,-176],"parameters":{"table":"user_verifications","schema":"public","options":{},"operation":"update"},"typeVersion":2},{"id":"9f8cbc2e-0acd-4c57-abda-5505f84e5d87","name":"Insert Session","type":"n8n-nodes-base.postgres","position":[320,0],"parameters":{"table":"user_sessions","schema":"public","options":{}},"typeVersion":2},{"id":"6bac846e-310c-48dd-a46c-35bc2a9909f6","name":"Verify Success Response","type":"n8n-nodes-base.respondToWebhook","position":[560,-128],"parameters":{"options":{},"respondWith":"json","responseBody":"{\"success\": true, \"message\": \"Verified successfully\", \"session_id\": \"{{ $('Create Session').item.json.session_id }}\"}"},"typeVersion":1},{"id":"52f8f128-a14c-477b-a3b2-48280925f6cd","name":"Verify Failed Response","type":"n8n-nodes-base.respondToWebhook","position":[112,128],"parameters":{"options":{},"respondWith":"json","responseBody":"{\"success\": false, \"message\": \"Invalid or expired verification code\"}"},"typeVersion":1},{"id":"00749335-1838-4ffa-9ae4-743d2aa9db76","name":"Incoming SMS Webhook (Twilio)","type":"n8n-nodes-base.webhook","notes":"Configure this URL in your Twilio phone number settings","position":[-768,896],"webhookId":"8f4bd373-3db2-404b-8611-854124786ec8","parameters":{"path":"twilio_sms_incoming","options":{},"httpMethod":"POST","responseMode":"responseNode"},"typeVersion":1},{"id":"38aded6e-ea7d-46ef-994e-cae14a0d480b","name":"ðŸ¤– AI Sentiment Analysis","type":"n8n-nodes-base.openAi","notes":"AI NODE 1: Analyzes sentiment, urgency, intent from free-text","position":[-160,896],"parameters":{"model":{"__rl":true,"mode":"list","value":"gpt-4"},"options":{"maxTokens":500,"temperature":0.3},"requestOptions":{}},"credentials":{"openAiApi":{"id":"CVkVgSCNZdeF7qvY","name":"OpenAi account 2"}},"typeVersion":1},{"id":"2d330b5b-ee12-4f51-b97d-371372b7ca5a","name":"Process AI Analysis","type":"n8n-nodes-base.code","position":[32,896],"parameters":{"jsCode":"let aiAnalysis;\ntry {\n  const raw = $input.item.json.message?.content || '{}';\n  aiAnalysis = JSON.parse(raw.replace(/```json\\n?|```/g, ''));\n} catch (e) {\n  aiAnalysis = {\n    sentiment: 'neutral',\n    urgency_score: 5,\n    intent: 'continue_intake',\n    requires_escalation: false,\n    detected_keywords: [],\n    summary: $('Extract SMS Data1').item.json.message_body\n  };\n}\n\nconst sessionData = $('Find User Session1').item.json;\nlet intakeData = JSON.parse(sessionData.intake_data || '{}');\nif (!intakeData.transcript) intakeData.transcript = [];\nif (!intakeData.ai_metadata) intakeData.ai_metadata = {};\n\nintakeData.transcript.push({\n  message: $('Extract SMS Data1').item.json.message_body,\n  timestamp: $('Extract SMS Data1').item.json.received_at,\n  direction: 'incoming',\n  ai_analysis: aiAnalysis\n});\n\nintakeData.ai_metadata.last_sentiment = aiAnalysis.sentiment;\nintakeData.ai_metadata.last_intent = aiAnalysis.intent;\nintakeData.ai_metadata.max_urgency = Math.max(intakeData.ai_metadata.max_urgency || 0, aiAnalysis.urgency_score);\n\nreturn {\n  session_id: sessionData.session_id,\n  phone_number: sessionData.phone_number,\n  status: sessionData.status,\n  intake_data: JSON.stringify(intakeData),\n  ai_analysis: aiAnalysis,\n  original_message: $('Extract SMS Data1').item.json.message_body\n};"},"typeVersion":2},{"id":"7e897558-7fa2-45bf-9422-e3187ecf988f","name":"ðŸ¤– AI Escalation Router","type":"n8n-nodes-base.switch","notes":"AI NODE 2: Routes escalations based on AI-detected frustration","position":[240,896],"parameters":{"rules":{"values":[{"conditions":{"options":{"version":1,"leftValue":"","caseSensitive":true,"typeValidation":"strict"},"combinator":"and","conditions":[{"id":"906d938e-3b91-4027-90ba-b30866c59d12","operator":{"type":"string","operation":"equals"},"leftValue":"","rightValue":""}]}}]},"options":{}},"typeVersion":3},{"id":"af73afcd-3a1c-4b12-a198-4920e2451509","name":"Mark Session Escalated","type":"n8n-nodes-base.postgres","position":[640,896],"parameters":{"table":"user_sessions","schema":"public","options":{},"operation":"update"},"typeVersion":2},{"id":"1527d4a4-a488-422f-8b84-78e4d71c679a","name":"Send Escalation Email","type":"n8n-nodes-base.gmail","position":[832,896],"webhookId":"977b9243-5239-4de3-9636-3c9e99aff04e","parameters":{"sendTo":"support@company.com","message":"=AI-Detected Escalation Alert\n\nPhone: {{ $('Process AI Analysis').item.json.phone_number }}\nSession: {{ $('Process AI Analysis').item.json.session_id }}\n\nSentiment: {{ $('Process AI Analysis').item.json.ai_analysis.sentiment }}\nUrgency: {{ $('Process AI Analysis').item.json.ai_analysis.urgency_score }}/10\nIntent: {{ $('Process AI Analysis').item.json.ai_analysis.intent }}\n\nMessage: {{ $('Process AI Analysis').item.json.original_message }}\n\nAI Summary: {{ $('Process AI Analysis').item.json.ai_analysis.summary }}\nKeywords: {{ $('Process AI Analysis').item.json.ai_analysis.detected_keywords.join(', ') }}","options":{},"subject":"ðŸš¨ AI Escalation: {{ $('Process AI Analysis').item.json.ai_analysis.sentiment }}"},"typeVersion":2},{"id":"dcbe49b5-e58f-4f17-92a5-5e1f09bfc81f","name":"ðŸ¤– AI Intent Router","type":"n8n-nodes-base.switch","notes":"AI NODE 3: Routes based on AI-detected user intent","position":[-624,1360],"parameters":{"rules":{"values":[{"conditions":{"options":{"leftValue":"","caseSensitive":true,"typeValidation":"strict"},"combinator":"and","conditions":[{"operator":{"type":"string","operation":"equals"},"leftValue":"","rightValue":""}]}}]},"options":{}},"typeVersion":3},{"id":"f50c06a8-78ff-44da-960a-4ca2580c59a7","name":"ðŸ¤– AI Intake Enrichment","type":"n8n-nodes-base.openAi","notes":"AI NODE 4: Extracts structured data from free-text","position":[-352,1168],"parameters":{"model":{"__rl":true,"mode":"list","value":"gpt-4"},"options":{"maxTokens":500,"temperature":0.3},"requestOptions":{}},"typeVersion":1},{"id":"c0ecc55a-f014-49d0-9d25-6a19558aa812","name":"Merge Enriched Data","type":"n8n-nodes-base.code","position":[-160,1168],"parameters":{"jsCode":"let enrichment;\ntry {\n  const raw = $input.item.json.message?.content || '{}';\n  enrichment = JSON.parse(raw.replace(/```json\\n?|```/g, ''));\n} catch (e) {\n  enrichment = {extracted_info: {}, completeness_score: 0, suggested_next_question: 'Tell me more?', category: 'general'};\n}\n\nconst sessionData = $('Process AI Analysis').item.json;\nlet intakeData = JSON.parse(sessionData.intake_data);\n\nif (!intakeData.structured_data) intakeData.structured_data = {};\nObject.assign(intakeData.structured_data, enrichment.extracted_info);\n\nintakeData.ai_metadata.completeness_score = enrichment.completeness_score;\nintakeData.ai_metadata.category = enrichment.category;\nintakeData.ai_metadata.suggested_next_question = enrichment.suggested_next_question;\n\nreturn {\n  session_id: sessionData.session_id,\n  phone_number: sessionData.phone_number,\n  intake_data: JSON.stringify(intakeData),\n  updated_at: new Date().toISOString(),\n  suggested_response: enrichment.suggested_next_question,\n  completeness_score: enrichment.completeness_score\n};"},"typeVersion":2},{"id":"e17b6c77-172a-4d92-9d56-40a967d16ceb","name":"ðŸ¤– AI Response Generator","type":"n8n-nodes-base.openAi","notes":"AI NODE 5: Generates contextual SMS responses","position":[240,1168],"parameters":{"model":{"__rl":true,"mode":"list","value":"gpt-4"},"options":{"maxTokens":200,"temperature":0.7},"requestOptions":{}},"typeVersion":1},{"id":"2e1336bd-ca0f-44ff-9129-af5aa1975df4","name":"Send AI Response SMS","type":"n8n-nodes-base.httpRequest","position":[448,1168],"parameters":{"url":"https://api.twilio.com/2010-04-01/Accounts/{{ $credentials.accountSid }}/Messages.json","options":{},"sendBody":true,"authentication":"genericCredentialType","bodyParameters":{"parameters":[{"name":"To","value":"={{ $('Merge Enriched Data').item.json.phone_number }}"},{"name":"From","value":"+1234567890"},{"name":"Body","value":"={{ $json.message?.content }}"}]},"genericAuthType":"httpBasicAuth"},"typeVersion":4},{"id":"daba2444-d8ca-416c-a445-47804dd4eeac","name":"Prepare Closeout","type":"n8n-nodes-base.code","position":[-272,1472],"parameters":{"jsCode":"const sessionData = $('Process AI Analysis').item.json;\nlet intakeData = JSON.parse(sessionData.intake_data);\n\nintakeData.completed_at = new Date().toISOString();\nintakeData.status = 'completed';\n\nconst filename = `transcripts/${sessionData.session_id}_${Date.now()}.json`;\n\nreturn {\n  session_id: sessionData.session_id,\n  phone_number: sessionData.phone_number,\n  intake_data: JSON.stringify(intakeData),\n  status: 'completed',\n  completed_at: intakeData.completed_at,\n  final_transcript: JSON.stringify(intakeData, null, 2),\n  s3_filename: filename\n};"},"typeVersion":2},{"id":"8029ca3a-d4de-4ba2-8dd3-98b7b46affe9","name":"Finalize Session","type":"n8n-nodes-base.postgres","position":[-48,1376],"parameters":{"table":"user_sessions","schema":"public","options":{},"operation":"update"},"typeVersion":2},{"id":"43644ecd-9484-48fb-a587-67e7eb74d9c9","name":"Upload to S3","type":"n8n-nodes-base.awsS3","position":[-48,1520],"parameters":{"fileKey":"={{ $('Prepare Closeout').item.json.s3_filename }}"},"typeVersion":1},{"id":"4665d2ec-142f-489a-ac10-97be857bd65c","name":"ðŸ¤– AI Personalized Closeout","type":"n8n-nodes-base.openAi","notes":"AI NODE 6: Generates personalized thank you","position":[160,1456],"parameters":{"model":{"__rl":true,"mode":"list","value":"gpt-4"},"options":{"maxTokens":200,"temperature":0.8},"requestOptions":{}},"typeVersion":1},{"id":"539b4702-b7de-4014-9600-96c81e40567d","name":"Send Closeout SMS","type":"n8n-nodes-base.httpRequest","position":[352,1456],"parameters":{"url":"https://api.twilio.com/2010-04-01/Accounts/{{ $credentials.accountSid }}/Messages.json","options":{},"sendBody":true,"authentication":"genericCredentialType","bodyParameters":{"parameters":[{"name":"To","value":"={{ $('Prepare Closeout').item.json.phone_number }}"},{"name":"From","value":"+1234567890"},{"name":"Body","value":"={{ $json.message?.content }}"}]},"genericAuthType":"httpBasicAuth"},"typeVersion":4},{"id":"2d6c8470-6c1a-4504-aeaa-77de599261b8","name":"SMS Webhook Response","type":"n8n-nodes-base.respondToWebhook","position":[976,1344],"parameters":{"options":{},"respondWith":"text","responseBody":"OK"},"typeVersion":1},{"id":"9d632faa-1a2a-492b-a270-45f9c43a7d73","name":"Follow-Up Cron (24h)","type":"n8n-nodes-base.cron","position":[-288,1824],"parameters":{},"typeVersion":1},{"id":"3ba98821-8843-4810-beca-7ee280ba94a2","name":"Find Inactive Sessions","type":"n8n-nodes-base.postgres","position":[-80,1824],"parameters":{"table":"user_sessions","where":{"values":[{"value":"active","column":"status"},{"value":"={{ new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString() }}","column":"updated_at","condition":"smallerEqual"}]},"schema":"public","options":{},"operation":"select"},"typeVersion":2},{"id":"626da322-0a2c-4621-b955-23e09c38d65c","name":"ðŸ¤– AI Personalized Reminder","type":"n8n-nodes-base.openAi","notes":"AI NODE 7: Generates contextual follow-up reminders","position":[144,1824],"parameters":{"model":{"__rl":true,"mode":"list","value":"gpt-4"},"options":{"maxTokens":200,"temperature":0.8},"requestOptions":{}},"typeVersion":1},{"id":"eb954b83-6379-482b-b726-0fa2f25f486d","name":"Send Reminder SMS","type":"n8n-nodes-base.httpRequest","position":[368,1824],"parameters":{"url":"https://api.twilio.com/2010-04-01/Accounts/{{ $credentials.accountSid }}/Messages.json","options":{},"sendBody":true,"authentication":"genericCredentialType","bodyParameters":{"parameters":[{"name":"To","value":"={{ $json.phone_number }}"},{"name":"From","value":"+1234567890"},{"name":"Body","value":"={{ $('ðŸ¤– AI Personalized Reminder').item.json.message?.content }}"}]},"genericAuthType":"httpBasicAuth"},"typeVersion":4},{"id":"106e3596-6282-451c-b5d7-2c99177c38eb","name":"User Signup Webhook1","type":"n8n-nodes-base.webhook","position":[-480,-400],"webhookId":"c5e4ddb5-eb2d-49c9-b06d-fe9b44883d71","parameters":{"path":"user_signup","options":{},"httpMethod":"POST","responseMode":"responseNode"},"typeVersion":1},{"id":"abc53c9c-8c51-4c7b-9153-150ee93033fe","name":"Generate Verification Code1","type":"n8n-nodes-base.code","position":[-272,-400],"parameters":{"jsCode":"const code = Math.floor(100000 + Math.random() * 900000).toString();\nconst phoneNumber = $input.item.json.phone_number;\nconst expiryTime = new Date(Date.now() + 10 * 60 * 1000).toISOString();\n\nreturn {\n  phone_number: phoneNumber,\n  verification_code: code,\n  expires_at: expiryTime,\n  created_at: new Date().toISOString(),\n  verified: false\n};"},"typeVersion":2},{"id":"159949cc-b1ba-4f82-bac6-1031eb22288d","name":"Signup Response1","type":"n8n-nodes-base.respondToWebhook","position":[320,-400],"parameters":{"options":{},"respondWith":"json","responseBody":"{\"success\": true, \"message\": \"Verification code sent to {{ $('Generate Verification Code').item.json.phone_number }}\"}"},"typeVersion":1},{"id":"508216e9-98b4-42d7-954c-e92b66e4d067","name":"Verify Code Webhook1","type":"n8n-nodes-base.webhook","position":[-688,-16],"webhookId":"b9f92b5c-09ca-496d-a767-d5eb2ad6f27d","parameters":{"path":"verify_code","options":{},"httpMethod":"POST","responseMode":"responseNode"},"typeVersion":1},{"id":"aa25aec4-c813-49f3-8997-05467e73ecd3","name":"Extract Verification Data1","type":"n8n-nodes-base.code","position":[-480,-16],"parameters":{"jsCode":"return {\n  phone_number: $input.item.json.phone_number,\n  submitted_code: $input.item.json.verification_code,\n  current_time: new Date().toISOString()\n};"},"typeVersion":2},{"id":"fc2d58b1-bdec-4109-bbf1-d21204fda108","name":"Extract SMS Data1","type":"n8n-nodes-base.code","position":[-560,896],"parameters":{"jsCode":"return {\n  from_number: $input.item.json.From,\n  message_body: $input.item.json.Body || '',\n  message_sid: $input.item.json.MessageSid,\n  received_at: new Date().toISOString()\n};"},"typeVersion":2},{"id":"9a4aeb83-01a6-456a-87dc-37236d255a18","name":"Find User Session1","type":"n8n-nodes-base.postgres","position":[-368,896],"parameters":{"sort":{"values":[{"column":"created_at","direction":"DESC"}]},"limit":1,"table":"user_sessions","where":{"values":[{"value":"={{ $json.from_number }}","column":"phone_number"}]},"schema":"public","options":{},"operation":"select"},"typeVersion":2},{"id":"434fea61-dc4b-4be1-bd56-b92c95f77eb5","name":"Prepare Escalation Data1","type":"n8n-nodes-base.code","position":[448,896],"parameters":{"jsCode":"return {\n  session_id: $('Process AI Analysis').item.json.session_id,\n  status: 'escalated',\n  escalated_at: new Date().toISOString()\n};"},"typeVersion":2},{"id":"8c5c51ab-feb6-4e31-8e91-1f1b3ea95294","name":"Send Escalation SMS1","type":"n8n-nodes-base.httpRequest","position":[1008,896],"parameters":{"url":"https://api.twilio.com/2010-04-01/Accounts/{{ $credentials.accountSid }}/Messages.json","options":{},"sendBody":true,"authentication":"genericCredentialType","bodyParameters":{"parameters":[{"name":"To","value":"={{ $('Process AI Analysis').item.json.phone_number }}"},{"name":"From","value":"+1234567890"},{"name":"Body","value":"We understand this is important to you. A team member will contact you shortly. Session ID: {{ $('Process AI Analysis').item.json.session_id }}"}]},"genericAuthType":"httpBasicAuth"},"typeVersion":4},{"id":"9e8c77ff-0e8b-4f9b-b79f-4e7f5f365c54","name":"Save Enriched Intake1","type":"n8n-nodes-base.postgres","position":[48,1168],"parameters":{"table":"user_sessions","schema":"public","options":{},"operation":"update"},"typeVersion":2},{"id":"f7f12917-d522-4e8c-96f6-81301984ae89","name":"Sticky Note4","type":"n8n-nodes-base.stickyNote","position":[-400,1728],"parameters":{"color":5,"width":976,"height":304,"content":"## Followup agent"},"typeVersion":1},{"id":"2695223c-4024-4622-95de-d7a3a51dbb76","name":"Sticky Note5","type":"n8n-nodes-base.stickyNote","position":[-432,1360],"parameters":{"color":4,"width":992,"height":304,"content":"## Close Out"},"typeVersion":1},{"id":"0a61ced3-3938-49aa-b5e3-bf78cb0e9b7f","name":"Sticky Note6","type":"n8n-nodes-base.stickyNote","position":[384,832],"parameters":{"color":3,"width":784,"height":208,"content":"## Human Escalation "},"typeVersion":1},{"id":"77fef9b3-32cc-4f76-b386-84eedeadc96e","name":"Sticky Note7","type":"n8n-nodes-base.stickyNote","position":[-432,1120],"parameters":{"color":2,"width":1024,"height":208,"content":"## Help Request"},"typeVersion":1},{"id":"f0979bbd-5c3f-4ca3-ab27-b2177ee7b252","name":"Sticky Note8","type":"n8n-nodes-base.stickyNote","position":[-1808,-416],"parameters":{"width":560,"height":816,"content":" ## How it works\n\n1. **User Signup & Verification:**  \n   The workflow starts when a user signs up. It generates a verification code and sends it via SMS using Twilio.\n\n2. **Code Validation:**  \n   The user replies with the code. The workflow checks the code and, if valid, creates a session for the user.\n\n3. **Conversational AI:**  \n   Incoming SMS messages are analyzed by Chat GPT AI for sentiment, intent, and urgency. The workflow stores the conversation context and generates smart, AI-powered replies.\n\n4. **Escalation Handling:**  \n   If the AI detects urgency or frustration, the workflow escalates the sessionâ€”alerting your team and sending a supportive SMS to the user.\n\n---\n\n## Set up steps\n\n- **Estimated setup time:** 10â€“20 minutes for most users.\n- **What youâ€™ll need:**  \n  - A free n8n account (self-hosted or cloud)\n  - Free Twilio account (for SMS)\n  - ChatGPT API key (for AI)\n  - A PostgreSQL database (Supabase, Neon, or local)\n\n- **Setup process:**  \n  1. Import this workflow into n8n.\n  2. Add your Twilio and Groq credentials as environment variables or n8n credentials.\n  3. Update webhook URLs in your Twilio console (for incoming SMS).\n  4. (Optional) Adjust sticky notes in the workflow for detailed, step-by-step guidance."},"typeVersion":1}],"active":false,"pinData":{},"settings":{"executionOrder":"v1"},"versionId":"2d0e4272-34e2-4a03-8249-1e4492ad7376","connections":{"Upload to S3":{"main":[[{"node":"ðŸ¤– AI Personalized Closeout","type":"main","index":0}]]},"Mark Verified":{"main":[[{"node":"Verify Success Response","type":"main","index":0}]]},"Validate Code":{"main":[[{"node":"Create Session","type":"main","index":0},{"node":"Verify Failed Response","type":"main","index":0}]]},"Create Session":{"main":[[{"node":"Mark Verified","type":"main","index":0},{"node":"Insert Session","type":"main","index":0}]]},"Insert Session":{"main":[[{"node":"Verify Success Response","type":"main","index":0}]]},"Extract SMS Data":{"main":[[{"node":"Find User Session","type":"main","index":0}]]},"Finalize Session":{"main":[[{"node":"ðŸ¤– AI Personalized Closeout","type":"main","index":0}]]},"Prepare Closeout":{"main":[[{"node":"Finalize Session","type":"main","index":0},{"node":"Upload to S3","type":"main","index":0}]]},"Extract SMS Data1":{"main":[[{"node":"Find User Session1","type":"main","index":0}]]},"Find User Session":{"main":[[{"node":"AI Sentiment & Intent Analysis","type":"main","index":0}]]},"Send Closeout SMS":{"main":[[{"node":"SMS Webhook Response","type":"main","index":0}]]},"Check Verification":{"main":[[{"node":"Validate Code","type":"main","index":0}]]},"Find User Session1":{"main":[[{"node":"ðŸ¤– AI Sentiment Analysis","type":"main","index":0}]]},"Store Verification":{"main":[[{"node":"Send Verification SMS (Twilio API)","type":"main","index":0}]]},"Merge Enriched Data":{"main":[[{"node":"Save Enriched Intake1","type":"main","index":0}]]},"Process AI Analysis":{"main":[[{"node":"ðŸ¤– AI Escalation Router","type":"main","index":0}]]},"AI Escalation Router":{"main":[[{"node":"Prepare Escalation Data","type":"main","index":0}]]},"Follow-Up Cron (24h)":{"main":[[{"node":"Find Inactive Sessions","type":"main","index":0}]]},"Incoming SMS Webhook":{"main":[[{"node":"Extract SMS Data","type":"main","index":0}]]},"Send AI Response SMS":{"main":[[{"node":"SMS Webhook Response","type":"main","index":0}]]},"Send Escalation SMS1":{"main":[[{"node":"SMS Webhook Response","type":"main","index":0}]]},"User Signup Webhook1":{"main":[[{"node":"Generate Verification Code1","type":"main","index":0}]]},"Verify Code Webhook1":{"main":[[{"node":"Extract Verification Data1","type":"main","index":0}]]},"Save Enriched Intake1":{"main":[[{"node":"ðŸ¤– AI Response Generator","type":"main","index":0}]]},"Send Escalation Email":{"main":[[{"node":"Send Escalation SMS1","type":"main","index":0}]]},"ðŸ¤– AI Intent Router":{"main":[[{"node":"Prepare Closeout","type":"main","index":0},{"node":"ðŸ¤– AI Intake Enrichment","type":"main","index":0}]]},"Find Inactive Sessions":{"main":[[{"node":"ðŸ¤– AI Personalized Reminder","type":"main","index":0}]]},"Mark Session Escalated":{"main":[[{"node":"Send Escalation Email","type":"main","index":0}]]},"Prepare Escalation Data":{"main":[[{"node":"Mark Session as Escalated","type":"main","index":0},{"node":"Send AI Escalation Email","type":"main","index":0}]]},"Prepare Escalation Data1":{"main":[[{"node":"Mark Session Escalated","type":"main","index":0}]]},"Send AI Escalation Email":{"main":[[{"node":"Send Escalation SMS","type":"main","index":0}]]},"ðŸ¤– AI Escalation Router":{"main":[[{"node":"Prepare Escalation Data1","type":"main","index":0},{"node":"ðŸ¤– AI Intent Router","type":"main","index":0}]]},"ðŸ¤– AI Intake Enrichment":{"main":[[{"node":"Merge Enriched Data","type":"main","index":0}]]},"Extract Verification Data1":{"main":[[{"node":"Check Verification","type":"main","index":0}]]},"ðŸ¤– AI Response Generator":{"main":[[{"node":"Send AI Response SMS","type":"main","index":0}]]},"ðŸ¤– AI Sentiment Analysis":{"main":[[{"node":"Process AI Analysis","type":"main","index":0}]]},"Generate Verification Code1":{"main":[[{"node":"Store Verification","type":"main","index":0}]]},"Process & Store AI Analysis":{"main":[[{"node":"AI Escalation Router","type":"main","index":0}]]},"Incoming SMS Webhook (Twilio)":{"main":[[{"node":"Extract SMS Data1","type":"main","index":0}]]},"ðŸ¤– AI Personalized Closeout":{"main":[[{"node":"Send Closeout SMS","type":"main","index":0}]]},"ðŸ¤– AI Personalized Reminder":{"main":[[{"node":"Send Reminder SMS","type":"main","index":0}]]},"AI Sentiment & Intent Analysis":{"main":[[{"node":"Process & Store AI Analysis","type":"main","index":0}]]},"Send Verification SMS (Twilio API)":{"main":[[{"node":"Signup Response1","type":"main","index":0}]]}}}